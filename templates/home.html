{% extends "_base.html" %}
{% load static %}

{% block title %}kalibre{% endblock title %}

{% block content %}
  <div class="text-center">
    <h1 class="kalibre-title" style="font-size:100px">kalibre</h1>
    <div class="row justify-content-center">
      <div id="blue_reading_div" class="col-md-6"></div>
    </div>
    <div class="row justify-content-center">
      <div class="col-md-10">
        <form id="search-form" class="form-inline mt-2 mt-md-0 d-flex justify-content-center" action="{% url 'search_results' %}" method="get">
          <div id="search-input-container" class="d-inline-flex">
            <input name="db_q" class="form-control w-75 mr-2 mt-3" type="text" placeholder="what do you wanna read?">
            <button id="toggle-ai-librarian" onclick="init_ai_chatbox();" class="btn btn-sm btn-outline-secondary" title="AI Librarian" type="button" data-toggle="tooltip" data-placement="bottom" title="Toggle AI Librarian">
              <img id="toggle-ai-image" src="https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492031/kalibre_head_0_c4ln7c.png" width="50" height="50"/>
            </button>
          </div>
        </form>

        <div class="mt-4" id="ai-chatbox" style="display: none; background-color: #F1F8E9; border-radius: 5px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid #ccc; padding: 20px; overflow-y: scroll;">
          <div id="message-container">
            <!-- add text boxes dynamically using jQuery -->
            <textarea class='form-control mb-3' placeholder="hi, i'm Kalibre! what type of book are you looking for?"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes rotate-animation {
      0% {
        transform: rotate(-45deg);
      }
      100% {
        transform: rotate(45deg);
      }
    }

    .rotate {
      animation: rotate-animation 1s linear infinite alternate;
    }

    #toggle-ai-librarian {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 50%;
    }

    #search-input-container * {
      border-radius: 10px !important;
    }

    .user-message, .ai-response {
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
      padding-bottom: 10px;
    }
  
    .user-message {
      background-color: #e6f2ff;
      border-radius: 10px; /* Increase from 5px to 10px */
      padding: 10px;
    }
  
    .ai-response {
      background-color: #f0f8ff;
      border-radius: 10px; /* Increase from 5px to 10px */
      padding: 10px;
    }

    #ai-chatbox {
      max-height: 300px;
      overflow-y: scroll;
      scroll-behavior: smooth;
      border-radius: 10px; /* Increase from 5px to 10px */
    }

    #message-container {
      padding-top: 50px;
    }

    textarea {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #F1F8E9;
    }
    
    .loading-animation {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 5px;
    }
    
    .dot {
      width: 8px;
      height: 8px;
      background-color: #3498db;
      border-radius: 50%;
      display: inline-block;
      animation: bounce 1.5s infinite ease-in-out;
    }
    
    .dot:nth-child(2) {
      background-color: #e67e22;
      animation-delay: -0.4s;
    }

    .dot:nth-child(3) {
      background-color: #e74c3c;
      animation-delay: -0.8s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-15px);
      }
    }
  </style>

  <script>
    let conversationHistory = [];

    $(document).ready(function() {
      // Load kalibre faces
      let kalibre_faces = [
        "https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492031/kalibre_head_0_c4ln7c.png",
        "https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492030/kalibre_head_1_sel9zm.png",
        "https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492030/kalibre_head_2_p6cddp.png",
        "https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492031/kalibre_head_3_nbzijn.png",
        "https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492031/kalibre_head_4_dbjaoj.png",
        "https://res.cloudinary.com/dmh0kulu1/image/upload/c_thumb,w_200,g_face/v1685492031/kalibre_head_5_uo1feu.png"
      ];

      $('#toggle-ai-librarian').mouseover(function() {
        let randomIndex = Math.floor(Math.random() * kalibre_faces.length);
        $('#toggle-ai-image').attr('src', kalibre_faces[randomIndex]);
      });

      // Enable the tooltip
      $('[data-toggle="tooltip"]').tooltip();

      // Fade in the body
      $("body").css("transition", "opacity 0.5s").css("opacity", "1");

      // Set a timeout to delay the entrance animations for h1 and the search input container
      setTimeout(function() {
        $("h1, #search-input-container").css("transition", "all 0.5s").css({
          "opacity": "1",
          "transform": "translateY(0)"
        });
      }, 100);

      var $textarea = $("textarea");

      // Add an event listener for the 'Enter' key
      $textarea.on("keydown", function(event) {
        if (event.key === "Enter") {
          event.preventDefault(); // Prevent the default behavior (new line)

          // Get the typed text
          var typedText = $textarea.val().trim();

          // If there's any text, store it in the chatbox div and clear the textarea
          if (typedText) {
            // Append the typed text to the chatbox div
            var messageDiv = $("<div>").text(typedText).addClass("user-message");
            $("#message-container").append(messageDiv);

            // Clear the textarea
            $textarea.val("");

            // Show the loading animation
            var loadingDiv = $("<div>").addClass("loading-animation");
            var dot1 = $("<div>").addClass("dot");
            var dot2 = $("<div>").addClass("dot");
            var dot3 = $("<div>").addClass("dot");
            loadingDiv.append(dot1, dot2, dot3);
            $("#message-container").append(loadingDiv);

            // Update the conversation history with the user's message
            conversationHistory.push({"role": "user", "content": typedText});

            // Send the message to the AI librarian and get a response
            getAiLibrarianResponse(conversationHistory).then(response => {
              // Remove the loading animation
              loadingDiv.remove();

              // Add the AI response to the chatbox
              var aiResponseDiv = $("<div>").text(response).addClass("ai-response");
              $("#message-container").append(aiResponseDiv);

              // animate the ai response
              aiResponseDiv.animate({opacity: 1}, 500);

              // Update the conversation history with the AI's response
              conversationHistory.push({"role": "assistant", "content": response});
            });
          }
        }
      });

    async function getAiLibrarianResponse(messages) {
      return new Promise(function(resolve, reject) {
        $('#toggle-ai-image').addClass('rotate');
        
        $.ajax({
          url: "/ai/ai-librarian/",
          type: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"), // Assuming you have a 'getCookie' function to fetch CSRF token
          },
          data: {
            messages: JSON.stringify(messages),
          },
          success: function(data) {
            resolve(data.message);
          },
          error: function(xhr, textStatus, errorThrown) {
            reject(errorThrown);
          }
        }).always(function() {
          $('#toggle-ai-image').removeClass('rotate');
          $('#toggle-ai-image').css('transition', 'transform 0.5s'); // Smoothly return to initial position
          $('#toggle-ai-image').css('transform', '');
        });
      });
    }
  });

  function init_ai_chatbox() {
    $("#ai-chatbox").fadeToggle();
    if (conversationHistory.length === 0) {
      var AI_PROMPT = "{{ AI_PROMPT }}";
      conversationHistory.push({"role": "system", "content": AI_PROMPT});
    }
  }

  </script>

{% endblock content %}